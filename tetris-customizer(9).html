<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TETRIS¬∑SCAPE ‚Äî Customize Your Web</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323:wght@400&display=swap');

  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1a1a28;
    --border: #2a2a40;
    --accent: #00fff0;
    --accent2: #ff00aa;
    --accent3: #ffee00;
    --text: #e0e0ff;
    --text-dim: #6060a0;
    --cell: 28px;
    --cols: 20;
    --rows: 22;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'VT323', monospace;
    font-size: 20px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  #bg-canvas {
    position: fixed; inset: 0; width: 100%; height: 100%;
    z-index: 0; pointer-events: none; opacity: 0; transition: opacity 1s;
  }
  #bg-canvas.active { opacity: 1; }

  body::after {
    content: ''; position: fixed; inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.08) 2px, rgba(0,0,0,0.08) 4px);
    pointer-events: none; z-index: 9999;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    position: relative; z-index: 10; text-align: center;
    padding: 16px 20px 14px; border-bottom: 2px solid var(--border);
    background: rgba(10,10,15,0.85); backdrop-filter: blur(10px);
    display: flex; align-items: center; justify-content: center;
    gap: 24px; flex-wrap: wrap;
  }
  .header-text h1 {
    font-family: 'Press Start 2P', monospace;
    font-size: clamp(13px, 2.5vw, 22px); letter-spacing: 4px;
    background: linear-gradient(90deg, var(--accent), var(--accent2), var(--accent3), var(--accent));
    background-size: 300%;
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    animation: rainbow 4s linear infinite;
  }
  .header-text p { color: var(--text-dim); font-size: 17px; margin-top: 4px; letter-spacing: 2px; }
  @keyframes rainbow { to { background-position: 300%; } }

  .btn-play-game {
    font-family: 'Press Start 2P', monospace; font-size: 10px; letter-spacing: 2px;
    background: linear-gradient(135deg, #ff00aa22, #ffee0022);
    border: 2px solid var(--accent3); color: var(--accent3);
    padding: 12px 20px; border-radius: 4px; cursor: pointer;
    text-shadow: 0 0 10px var(--accent3);
    box-shadow: 0 0 20px rgba(255,238,0,0.2);
    transition: all 0.2s;
    animation: pulse-play 2s ease-in-out infinite;
    flex-shrink: 0;
  }
  .btn-play-game:hover {
    background: linear-gradient(135deg, #ff00aa44, #ffee0044);
    box-shadow: 0 0 30px rgba(255,238,0,0.4); transform: scale(1.05);
  }
  @keyframes pulse-play {
    0%,100% { box-shadow: 0 0 15px rgba(255,238,0,0.2); }
    50%      { box-shadow: 0 0 30px rgba(255,238,0,0.5); }
  }

  /* ‚îÄ‚îÄ GAME OVERLAY ‚îÄ‚îÄ */
  #game-overlay {
    position: fixed; inset: 0; z-index: 500;
    background: rgba(4,4,10,0.97); backdrop-filter: blur(6px);
    display: none; flex-direction: column;
    align-items: center; justify-content: flex-start;
    padding: 16px; overflow-y: auto;
  }
  #game-overlay.open { display: flex; }

  .game-header {
    font-family: 'Press Start 2P', monospace;
    font-size: clamp(10px, 1.8vw, 16px); letter-spacing: 3px;
    background: linear-gradient(90deg, var(--accent3), var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    margin-bottom: 14px; text-align: center;
  }

  .game-layout {
    display: flex; gap: 16px; align-items: flex-start;
    flex-wrap: wrap; justify-content: center; width: 100%; max-width: 900px;
  }

  #game-board {
    display: grid;
    grid-template-columns: repeat(10, var(--cell));
    grid-template-rows: repeat(20, var(--cell));
    border: 2px solid var(--accent);
    position: relative;
    background:
      linear-gradient(rgba(255,255,255,0.18) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,0.18) 1px, transparent 1px);
    background-size: var(--cell) var(--cell);
    background-color: #04040c;
    box-shadow: 0 0 40px rgba(0,255,240,0.15), inset 0 0 40px rgba(0,0,0,0.5);
    flex-shrink: 0;
  }

  .game-cell { width: var(--cell); height: var(--cell); position: relative; }
  .game-cell.filled::before {
    content: ''; position: absolute; inset: 1px;
    background: var(--fill-color, #888);
    border-radius: 2px;
    box-shadow:
      inset 3px 3px 0px rgba(255,255,255,0.55),
      inset -3px -3px 0px rgba(0,0,0,0.45),
      inset 6px 6px 0px rgba(255,255,255,0.2),
      inset -6px -6px 0px rgba(0,0,0,0.2);
  }
  .game-cell.filled::after {
    content: ''; position: absolute;
    inset: 6px;
    border-radius: 1px;
    background: var(--fill-color, #888);
    filter: brightness(1.15);
    pointer-events: none;
    z-index: 1;
  }
  .game-cell.flash::before {
    background: #fff !important; box-shadow: 0 0 20px #fff !important;
    animation: flash-anim 0.3s ease;
  }
  @keyframes flash-anim { 0%,100%{opacity:1} 50%{opacity:0.3} }

  .ghost-cell {
    position: absolute; width: var(--cell); height: var(--cell);
    pointer-events: none; z-index: 3;
  }
  .ghost-cell::before {
    content: ''; position: absolute; inset: 1px;
    border: 2px solid rgba(255,255,255,0.25); border-radius: 2px;
  }

  .active-cell {
    position: absolute; width: var(--cell); height: var(--cell);
    pointer-events: none; z-index: 4;
  }
  .active-cell::before {
    content: ''; position: absolute; inset: 1px;
    background: var(--piece-color, #fff);
    border-radius: 2px;
    box-shadow:
      inset 3px 3px 0px rgba(255,255,255,0.55),
      inset -3px -3px 0px rgba(0,0,0,0.45),
      inset 6px 6px 0px rgba(255,255,255,0.2),
      inset -6px -6px 0px rgba(0,0,0,0.2),
      0 0 10px var(--piece-color, #fff);
  }
  .active-cell::after {
    content: ''; position: absolute;
    inset: 6px;
    border-radius: 1px;
    background: var(--piece-color, #fff);
    filter: brightness(1.15);
    pointer-events: none;
    z-index: 1;
  }

  .game-side { display: flex; flex-direction: column; gap: 12px; min-width: 140px; }

  .game-panel {
    background: rgba(18,18,26,0.95);
    border: 1px solid var(--border); border-radius: 4px; padding: 12px 14px;
  }
  .game-panel-title {
    font-family: 'Press Start 2P', monospace; font-size: 8px;
    color: var(--accent); letter-spacing: 2px; margin-bottom: 10px;
    text-shadow: 0 0 6px var(--accent);
  }
  .game-stat {
    font-family: 'Press Start 2P', monospace; font-size: 16px;
    color: var(--accent3); text-shadow: 0 0 10px var(--accent3);
    text-align: center; margin-bottom: 6px;
  }

  .ctrl-hint { font-size: 14px; color: var(--text-dim); line-height: 1.8; letter-spacing: 1px; }
  .ctrl-hint .k {
    color: var(--accent); background: var(--surface2);
    border: 1px solid var(--border); border-radius: 2px;
    padding: 1px 5px; font-size: 12px;
  }

  /* Game over / pause screens */
  #game-over-screen {
    position: absolute; inset: 0; background: rgba(4,4,12,0.92);
    display: none; flex-direction: column; align-items: center; justify-content: center;
    z-index: 20; backdrop-filter: blur(4px);
  }
  #game-over-screen.show { display: flex; }
  #game-over-screen h2 {
    font-family: 'Press Start 2P', monospace; font-size: clamp(11px,2.5vw,18px);
    color: var(--accent2); text-shadow: 0 0 20px var(--accent2);
    margin-bottom: 12px; animation: blink 1s step-end infinite;
  }
  @keyframes blink { 50% { opacity: 0; } }
  .final-score {
    font-family: 'Press Start 2P', monospace; font-size: 13px;
    color: var(--accent3); margin-bottom: 20px;
  }

  #pause-screen {
    position: absolute; inset: 0; background: rgba(4,4,12,0.85);
    display: none; flex-direction: column; align-items: center; justify-content: center;
    z-index: 20; backdrop-filter: blur(3px);
  }
  #pause-screen.show { display: flex; }
  #pause-screen h2 {
    font-family: 'Press Start 2P', monospace; font-size: 18px;
    color: var(--accent); text-shadow: 0 0 20px var(--accent);
    animation: blink 1.5s step-end infinite;
  }
  #pause-screen p { color: var(--text-dim); font-size: 16px; margin-top: 10px; }

  /* Direction arrows */
  .direction-display {
    display: grid;
    grid-template-areas: '. up .' 'left down right';
    gap: 4px; margin-top: 4px;
  }
  .dir-arrow {
    font-family: 'Press Start 2P', monospace; font-size: 10px;
    width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
    border: 1px solid var(--border); border-radius: 3px;
    background: var(--surface2); color: var(--text-dim);
    transition: all 0.1s; cursor: pointer;
  }
  .dir-arrow:hover { border-color: var(--accent3); }
  .dir-arrow.active {
    border-color: var(--accent3); color: var(--accent3);
    background: rgba(255,238,0,0.1); box-shadow: 0 0 8px rgba(255,238,0,0.3);
  }
  .dir-arrow[data-dir="up"]    { grid-area: up; }
  .dir-arrow[data-dir="left"]  { grid-area: left; }
  .dir-arrow[data-dir="down"]  { grid-area: down; }
  .dir-arrow[data-dir="right"] { grid-area: right; }

  /* ‚îÄ‚îÄ DESIGN EDITOR ‚îÄ‚îÄ */
  .app {
    position: relative; z-index: 10;
    display: flex; gap: 16px; padding: 16px;
    min-height: calc(100vh - 80px); align-items: flex-start;
    flex-wrap: wrap; justify-content: center;
  }

  .panel {
    background: rgba(18,18,26,0.92); border: 1px solid var(--border);
    border-radius: 4px; backdrop-filter: blur(8px);
  }
  .panel-title {
    font-family: 'Press Start 2P', monospace; font-size: 9px;
    letter-spacing: 2px; color: var(--accent); padding: 10px 14px 8px;
    border-bottom: 1px solid var(--border); text-shadow: 0 0 8px var(--accent);
  }

  .pieces-panel { width: 160px; flex-shrink: 0; }
  .pieces-grid { padding: 12px; display: flex; flex-direction: column; gap: 8px; }

  .piece-btn {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 3px; cursor: pointer; padding: 8px;
    display: flex; align-items: center; gap: 10px; transition: all 0.15s;
    color: var(--text); font-family: 'VT323', monospace;
    font-size: 16px; letter-spacing: 1px;
  }
  .piece-btn:hover { border-color: var(--accent); box-shadow: 0 0 8px rgba(0,255,240,0.2); }
  .piece-btn.active {
    border-color: var(--accent); background: rgba(0,255,240,0.08);
    box-shadow: 0 0 12px rgba(0,255,240,0.3);
  }
  .piece-preview { width: 44px; height: 32px; flex-shrink: 0; }

  .controls-panel { width: 160px; flex-shrink: 0; }
  .ctrl-section { padding: 10px 12px; border-bottom: 1px solid var(--border); }
  .ctrl-label {
    font-family: 'Press Start 2P', monospace; font-size: 7px;
    color: var(--text-dim); letter-spacing: 1px; margin-bottom: 8px; display: block;
  }

  .color-row { display: flex; flex-wrap: wrap; gap: 5px; }
  .color-swatch {
    width: 22px; height: 22px; border-radius: 2px; cursor: pointer;
    border: 2px solid transparent; transition: all 0.15s; flex-shrink: 0;
  }
  .color-swatch:hover { transform: scale(1.2); }
  .color-swatch.active { border-color: #fff; box-shadow: 0 0 6px #fff8; }

  .btn {
    display: block; width: 100%; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 3px;
    color: var(--text); font-family: 'VT323', monospace;
    font-size: 17px; letter-spacing: 1px; padding: 7px 10px;
    cursor: pointer; text-align: center; transition: all 0.15s; margin-bottom: 5px;
  }
  .btn:hover { border-color: var(--accent); background: rgba(0,255,240,0.07); }
  .btn:last-child { margin-bottom: 0; }
  .btn.danger:hover { border-color: #ff4455; background: rgba(255,68,85,0.07); color: #ff4455; }
  .btn.success {
    border-color: var(--accent2); color: var(--accent2); text-shadow: 0 0 8px var(--accent2);
  }
  .btn.success:hover { background: rgba(255,0,170,0.1); box-shadow: 0 0 12px rgba(255,0,170,0.2); }

  .kbd {
    font-size: 13px; color: var(--text-dim); background: var(--surface);
    border: 1px solid var(--border); border-radius: 2px; padding: 1px 5px; margin-left: 4px;
  }

  .canvas-panel { flex: 1; min-width: 300px; }
  .canvas-wrap { padding: 14px; display: flex; justify-content: center; }

  #editor-canvas {
    display: grid;
    grid-template-columns: repeat(var(--cols), var(--cell));
    grid-template-rows: repeat(var(--rows), var(--cell));
    border: 1px solid var(--border); cursor: crosshair;
    position: relative; user-select: none;
    background:
      linear-gradient(rgba(255,255,255,0.18) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,0.18) 1px, transparent 1px);
    background-size: var(--cell) var(--cell);
    background-color: #06060e; box-shadow: 0 0 40px rgba(0,255,240,0.05);
  }

  .cell { width: var(--cell); height: var(--cell); position: relative; }
  .cell.hovered { background: rgba(0,255,240,0.06); }

  .block { position: absolute; display: grid; z-index: 2; cursor: pointer; }
  .block-cell { width: var(--cell); height: var(--cell); position: relative; transition: filter 0.1s; }
  .block-cell::before {
    content: ''; position: absolute; inset: 1px;
    background: inherit;
    border-radius: 2px;
    box-shadow:
      inset 3px 3px 0px rgba(255,255,255,0.55),
      inset -3px -3px 0px rgba(0,0,0,0.45),
      inset 6px 6px 0px rgba(255,255,255,0.2),
      inset -6px -6px 0px rgba(0,0,0,0.2);
  }
  .block-cell::after {
    content: ''; position: absolute;
    inset: 5px;
    border-radius: 1px;
    background: inherit;
    filter: brightness(1.15);
    pointer-events: none;
  }
  .block.selected .block-cell::before {
    box-shadow:
      inset 3px 3px 0px rgba(255,255,255,0.55),
      inset -3px -3px 0px rgba(0,0,0,0.45),
      inset 6px 6px 0px rgba(255,255,255,0.2),
      inset -6px -6px 0px rgba(0,0,0,0.2),
      0 0 0 2.5px #fff, 0 0 14px rgba(255,255,255,0.5);
  }

  .status-bar {
    position: relative; z-index: 10; background: rgba(10,10,15,0.9);
    border-top: 1px solid var(--border); padding: 6px 20px;
    font-size: 15px; color: var(--text-dim); letter-spacing: 1px;
    display: flex; gap: 20px; flex-wrap: wrap;
  }
  .status-bar span { color: var(--accent); }

  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.8);
    z-index: 1000; display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(4px);
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal {
    background: var(--surface); border: 1px solid var(--accent); border-radius: 4px;
    padding: 30px; max-width: 400px; width: 90%;
    box-shadow: 0 0 60px rgba(0,255,240,0.2); text-align: center;
  }
  .modal h2 {
    font-family: 'Press Start 2P', monospace; font-size: 12px;
    color: var(--accent); margin-bottom: 16px; text-shadow: 0 0 10px var(--accent);
  }
  .modal p { color: var(--text-dim); font-size: 18px; margin-bottom: 20px; line-height: 1.5; }
  .modal-btns { display: flex; gap: 10px; justify-content: center; }
  .modal-btns .btn { margin-bottom: 0; width: auto; padding: 8px 20px; }

  .toast {
    position: fixed; bottom: 40px; left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--surface); border: 1px solid var(--accent);
    color: var(--accent); font-family: 'Press Start 2P', monospace;
    font-size: 9px; padding: 10px 20px; border-radius: 3px;
    z-index: 2000; letter-spacing: 2px; opacity: 0; transition: all 0.3s;
    box-shadow: 0 0 20px rgba(0,255,240,0.3); white-space: nowrap; pointer-events: none;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  .bg-mode-badge {
    position: fixed; top: 90px; right: 16px; z-index: 20;
    background: rgba(255,0,170,0.1); border: 1px solid var(--accent2);
    color: var(--accent2); font-family: 'Press Start 2P', monospace;
    font-size: 7px; padding: 6px 10px; border-radius: 3px;
    letter-spacing: 1px; text-shadow: 0 0 8px var(--accent2); display: none;
  }
  .bg-mode-badge.visible { display: block; }

  .rotate-indicator { font-size: 22px; text-align: center; padding: 4px; color: var(--accent3); }
</style>
</head>
<body>

<canvas id="bg-canvas"></canvas>
<div class="bg-mode-badge" id="bg-badge">‚ú¶ LIVE BG ACTIVE</div>

<header>
  <div class="header-text">
    <h1>‚ú¶ TETRIS¬∑SCAPE ‚ú¶</h1>
    <p>Stack blocks. Build worlds. Make the web yours.</p>
  </div>
  <button class="btn-play-game" id="btn-open-game">üéÆ PLAY TETRIS</button>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME OVERLAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="game-overlay">
  <div class="game-header">‚ñ∂ TETRIS¬∑SCAPE ‚Äî GAME MODE ‚óÄ</div>
  <div class="game-layout">

    <!-- LEFT: STATS + NEXT + DIRECTION -->
    <div class="game-side">
      <div class="game-panel">
        <div class="game-panel-title">SCORE</div>
        <div class="game-stat" id="g-score">0</div>
        <div class="game-panel-title" style="margin-top:10px">LINES</div>
        <div class="game-stat" id="g-lines">0</div>
        <div class="game-panel-title" style="margin-top:10px">LEVEL</div>
        <div class="game-stat" id="g-level">1</div>
      </div>
      <div class="game-panel">
        <div class="game-panel-title">NEXT</div>
        <canvas id="next-piece-canvas" width="80" height="60" style="display:block;margin:0 auto"></canvas>
      </div>
      <div class="game-panel">
        <div class="game-panel-title">GRAVITY</div>
        <div class="direction-display">
          <div class="dir-arrow" data-dir="up">‚Üë</div>
          <div class="dir-arrow" data-dir="left">‚Üê</div>
          <div class="dir-arrow" data-dir="down">‚Üì</div>
          <div class="dir-arrow" data-dir="right">‚Üí</div>
        </div>
        <div style="font-size:12px;color:var(--text-dim);margin-top:8px;text-align:center;line-height:1.6">
          Click arrows<br>to change fall direction
        </div>
      </div>
    </div>

    <!-- CENTER: BOARD -->
    <div style="position:relative;flex-shrink:0">
      <div id="game-board">
        <div id="game-over-screen">
          <h2>GAME OVER</h2>
          <div class="final-score" id="final-score-display">SCORE: 0</div>
          <button class="btn" id="btn-restart" style="width:180px;margin:0 auto 8px;font-family:'Press Start 2P',monospace;font-size:9px">‚ñ∂ PLAY AGAIN</button>
          <button class="btn" id="btn-keep-design" style="width:180px;margin:0 auto 8px;font-family:'Press Start 2P',monospace;font-size:9px;color:var(--accent2);border-color:var(--accent2)">‚ú¶ KEEP AS DESIGN</button>
          <button class="btn" id="btn-close-game-over" style="width:180px;margin:0 auto;font-family:'Press Start 2P',monospace;font-size:9px">‚úï EXIT</button>
        </div>
        <div id="pause-screen">
          <h2>PAUSED</h2>
          <p>Press P to resume</p>
        </div>
      </div>
    </div>

    <!-- RIGHT: CONTROLS -->
    <div class="game-side">
      <div class="game-panel">
        <div class="game-panel-title">CONTROLS</div>
        <div class="ctrl-hint">
          <div style="color:var(--accent);margin-bottom:2px">MOVE</div>
          <div><span class="k">‚Üê</span> Move Left</div>
          <div><span class="k">‚Üí</span> Move Right</div>
          <div><span class="k">‚Üë</span> Rotate CW</div>
          <div style="margin-bottom:8px"><span class="k">‚Üì</span> Soft Drop</div>
          <div style="color:var(--accent);margin-bottom:2px">ROTATE</div>
          <div><span class="k">Z</span> Rotate CW</div>
          <div style="margin-bottom:8px"><span class="k">X</span> Rotate CCW</div>
          <div><span class="k">Space</span> Hard drop</div>
          <div style="margin-top:4px"><span class="k">P</span> Pause</div>
        </div>
      </div>
      <div class="game-panel">
        <div class="game-panel-title">ACTIONS</div>
        <button class="btn" id="btn-pause-game" style="margin-bottom:8px">‚è∏ PAUSE <span class="kbd">P</span></button>
        <button class="btn danger" id="btn-restart2">‚Ü∫ RESTART</button>
        <button class="btn" id="btn-close-game" style="margin-top:8px;color:var(--text-dim)">‚úï EXIT GAME</button>
      </div>
      <div class="game-panel" style="font-size:14px;color:var(--text-dim);line-height:1.7;text-align:center">
        <div class="game-panel-title">TIP</div>
        Change gravity mid-game to flip the board! Lines clear along the gravity wall.
      </div>
    </div>

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DESIGN EDITOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="app">
  <div class="panel pieces-panel">
    <div class="panel-title">¬ª PIECES</div>
    <div class="pieces-grid" id="pieces-grid"></div>
  </div>

  <div class="panel canvas-panel">
    <div class="panel-title">¬ª CANVAS ‚Äî click to place ¬∑ click block to select</div>
    <div class="canvas-wrap">
      <div id="editor-canvas"></div>
    </div>
  </div>

  <div class="panel controls-panel">
    <div class="panel-title">¬ª CONTROLS</div>
    <div class="ctrl-section">
      <span class="ctrl-label">BLOCK COLOR</span>
      <div class="color-row" id="color-row"></div>
    </div>
    <div class="ctrl-section">
      <span class="ctrl-label">ROTATION</span>
      <div class="rotate-indicator" id="rot-indicator">‚Üë</div>
      <button class="btn" id="btn-rotate">Rotate <span class="kbd">R</span></button>
    </div>
    <div class="ctrl-section">
      <span class="ctrl-label">EDIT</span>
      <button class="btn danger" id="btn-delete">Delete Block <span class="kbd">Del</span></button>
      <button class="btn danger" id="btn-clear">Clear All</button>
    </div>
    <div class="ctrl-section">
      <span class="ctrl-label">BACKGROUND</span>
      <button class="btn success" id="btn-apply">‚ñ∂ Apply as BG</button>
      <button class="btn" id="btn-reset-bg">Reset BG</button>
    </div>
    <div class="ctrl-section">
      <span class="ctrl-label">STORAGE</span>
      <button class="btn" id="btn-save">üíæ Save Design</button>
      <button class="btn" id="btn-load">üìÇ Load Design</button>
      <button class="btn" id="btn-load-default">‚òÖ Load Default</button>
    </div>
  </div>
</div>

<div class="status-bar">
  <div>PIECE: <span id="st-piece">I</span></div>
  <div>COLOR: <span id="st-color">‚ñ†</span></div>
  <div>BLOCKS: <span id="st-count">0</span></div>
  <div>ROTATION: <span id="st-rot">0¬∞</span></div>
  <div id="st-sel-info" style="display:none">SELECTED: <span id="st-sel">‚Äî</span></div>
</div>

<div class="modal-overlay" id="modal">
  <div class="modal">
    <h2 id="modal-title">CONFIRM</h2>
    <p id="modal-body">Are you sure?</p>
    <div class="modal-btns">
      <button class="btn success" id="modal-ok">YES</button>
      <button class="btn" id="modal-cancel">NO</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const COLS = 20, ROWS = 22, CELL = 28;
const GC = 10, GR = 20; // game cols/rows

const PIECES = {
  I: { cells:[[0,0],[0,1],[0,2],[0,3]] },
  O: { cells:[[0,0],[0,1],[1,0],[1,1]] },
  T: { cells:[[0,0],[0,1],[0,2],[1,1]] },
  S: { cells:[[0,1],[0,2],[1,0],[1,1]] },
  Z: { cells:[[0,0],[0,1],[1,1],[1,2]] },
  J: { cells:[[0,0],[1,0],[1,1],[1,2]] },
  L: { cells:[[0,2],[1,0],[1,1],[1,2]] },
  X: { cells:[[0,0]] },
};

const PIECE_COLORS = {
  I:'#00fff0', O:'#ffee00', T:'#aa44ff',
  S:'#00ff88', Z:'#ff4455', J:'#22aaff', L:'#ff6622',
  X:'#ffffff',
};

const COLORS = [
  '#00fff0','#ff00aa','#ffee00','#00ff88',
  '#ff6622','#aa44ff','#ff4455','#22aaff',
  '#ffffff','#ffaa00','#44ffaa','#ff88cc',
];

const PIECE_TYPES = ['I','O','T','S','Z','J','L'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SHARED ROTATION UTIL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rotateCells(cells, rotation) {
  let r = cells.map(([a,b])=>[a,b]);
  for (let i = 0; i < rotation; i++) {
    r = r.map(([a,b])=>[b,-a]);
    const mr=Math.min(...r.map(([a])=>a)), mc=Math.min(...r.map(([,b])=>b));
    r = r.map(([a,b])=>[a-mr,b-mc]);
  }
  return r;
}

function getAbsoluteCells(block) {
  return rotateCells(PIECES[block.type].cells, block.rotation)
    .map(([r,c])=>[block.row+r, block.col+c]);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DESIGN EDITOR STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let state = {
  blocks:[], selectedId:null, activePiece:'I',
  activeColor:'#00fff0', activeRotation:0, bgActive:false, nextId:1,
};

const DEFAULT_DESIGN = (function() {
  // Pixel art "N" letter ‚Äî recreated from the reference image
  // Colors cycle through the rainbow like in the image (multicolor diagonal stripes)
  const PALETTE = ['#ff4455','#ff6622','#ffee00','#00ff88','#22aaff','#aa44ff','#ff00aa','#00fff0'];
  function pc(r, c) { return PALETTE[(r + c) % PALETTE.length]; }

  // The "N" shape on a 16x14 grid (rows 3-18, cols 2-17 on the 20-wide canvas)
  // 1 = filled pixel, 0 = empty
  const shape = [
    [1,1,0,0,0,0,0,0,0,0,0,0,1,1],
    [1,1,1,0,0,0,0,0,0,0,0,1,1,1],
    [1,1,1,1,0,0,0,0,0,0,1,1,1,1],
    [1,1,0,1,1,0,0,0,0,1,1,0,1,1],
    [1,1,0,0,1,1,0,0,1,1,0,0,1,1],
    [1,1,0,0,0,1,1,1,1,0,0,0,1,1],
    [1,1,0,0,0,0,1,1,0,0,0,0,1,1],
    [1,1,0,0,0,0,1,1,0,0,0,0,1,1],
    [1,1,0,0,0,1,1,1,1,0,0,0,1,1],
    [1,1,0,0,1,1,0,0,1,1,0,0,1,1],
    [1,1,0,1,1,0,0,0,0,1,1,0,1,1],
    [1,1,1,1,0,0,0,0,0,0,1,1,1,1],
    [1,1,1,0,0,0,0,0,0,0,0,1,1,1],
    [1,1,0,0,0,0,0,0,0,0,0,0,1,1],
    [1,1,0,0,0,0,0,0,0,0,0,0,1,1],
    [1,1,0,0,0,0,0,0,0,0,0,0,1,1],
  ];

  const rowOffset = 3, colOffset = 3;
  const blocks = [];
  let id = 1;
  for (let r = 0; r < shape.length; r++) {
    for (let c = 0; c < shape[r].length; c++) {
      if (shape[r][c]) {
        blocks.push({
          id: id++,
          type: 'X',
          row: r + rowOffset,
          col: c + colOffset,
          rotation: 0,
          color: pc(r, c),
        });
      }
    }
  }
  return { bgActive: true, nextId: id, blocks };
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DESIGN EDITOR DOM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const editorEl = document.getElementById('editor-canvas');
const cells2d = [];

function buildGrid() {
  editorEl.innerHTML = ''; cells2d.length = 0;
  for (let r=0;r<ROWS;r++) {
    cells2d[r]=[];
    for (let c=0;c<COLS;c++) {
      const el=document.createElement('div');
      el.className='cell'; el.dataset.r=r; el.dataset.c=c;
      editorEl.appendChild(el); cells2d[r][c]=el;
    }
  }
}

function buildPieceButtons() {
  const grid=document.getElementById('pieces-grid'); grid.innerHTML='';
  Object.keys(PIECES).forEach(key=>{
    const btn=document.createElement('button');
    btn.className='piece-btn'+(key===state.activePiece?' active':'');
    btn.dataset.piece=key;
    const pv=document.createElement('canvas'); pv.className='piece-preview';
    pv.width=44; pv.height=32;
    drawPiecePreview(pv,key,PIECE_COLORS[key]);
    btn.appendChild(pv); btn.appendChild(document.createTextNode(key+' BLOCK'));
    btn.addEventListener('click',()=>selectPiece(key));
    grid.appendChild(btn);
  });
}

function drawPiecePreview(canvas,type,color) {
  const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height);
  const cells=PIECES[type].cells; const s=9;
  cells.forEach(([r,c])=>{
    ctx.fillStyle=color; ctx.fillRect(c*s+1,r*s+1,s-2,s-2);
    ctx.fillStyle='rgba(255,255,255,0.25)'; ctx.fillRect(c*s+1,r*s+1,s-2,3);
  });
}

function buildColorSwatches() {
  const row=document.getElementById('color-row'); row.innerHTML='';
  COLORS.forEach(c=>{
    const sw=document.createElement('div');
    sw.className='color-swatch'+(c===state.activeColor?' active':'');
    sw.style.background=c; sw.style.boxShadow=`0 0 6px ${c}88`; sw.title=c;
    sw.addEventListener('click',()=>selectColor(c));
    row.appendChild(sw);
  });
}

function renderBlocks() {
  editorEl.querySelectorAll('.block').forEach(el=>el.remove());
  state.blocks.forEach(block=>{
    const cells=rotateCells(PIECES[block.type].cells,block.rotation);
    const maxR=Math.max(...cells.map(([r])=>r));
    const maxC=Math.max(...cells.map(([,c])=>c));
    const blockEl=document.createElement('div');
    blockEl.className='block'+(block.id===state.selectedId?' selected':'');
    blockEl.dataset.id=block.id;
    blockEl.style.gridColumn=`${block.col+1}/${block.col+maxC+2}`;
    blockEl.style.gridRow=`${block.row+1}/${block.row+maxR+2}`;
    blockEl.style.display='grid';
    blockEl.style.gridTemplateColumns=`repeat(${maxC+1},var(--cell))`;
    blockEl.style.gridTemplateRows=`repeat(${maxR+1},var(--cell))`;
    cells.forEach(([r,c])=>{
      const cellEl=document.createElement('div');
      cellEl.className='block-cell';
      cellEl.style.gridColumn=c+1; cellEl.style.gridRow=r+1;
      cellEl.style.background=block.color;
      cellEl.style.boxShadow=`0 0 8px ${block.color}88`;
      blockEl.appendChild(cellEl);
    });
    blockEl.addEventListener('click',e=>{e.stopPropagation();selectBlock(block.id);});
    editorEl.appendChild(blockEl);
  });
  updateStatus();
}

let hoverCells=[];
editorEl.addEventListener('mousemove',e=>{
  const cellEl=e.target.closest('.cell'); clearHover();
  if(!cellEl)return;
  const r=parseInt(cellEl.dataset.r), c=parseInt(cellEl.dataset.c);
  const cells=rotateCells(PIECES[state.activePiece].cells,state.activeRotation);
  hoverCells=cells.map(([dr,dc])=>{
    const tr=r+dr,tc=c+dc;
    if(tr>=0&&tr<ROWS&&tc>=0&&tc<COLS){cells2d[tr][tc].classList.add('hovered');return[tr,tc];}
    return null;
  }).filter(Boolean);
});
editorEl.addEventListener('mouseleave',clearHover);
function clearHover(){hoverCells.forEach(([r,c])=>cells2d[r]?.[c]?.classList.remove('hovered'));hoverCells=[];}

editorEl.addEventListener('click',e=>{
  if(e.target.closest('.block'))return;
  const cellEl=e.target.closest('.cell'); if(!cellEl)return;
  const r=parseInt(cellEl.dataset.r),c=parseInt(cellEl.dataset.c);
  const cells=rotateCells(PIECES[state.activePiece].cells,state.activeRotation);
  const valid=cells.every(([dr,dc])=>{const tr=r+dr,tc=c+dc;return tr>=0&&tr<ROWS&&tc>=0&&tc<COLS;});
  if(!valid){toast('OUT OF BOUNDS!');return;}
  state.blocks.push({id:state.nextId++,type:state.activePiece,row:r,col:c,rotation:state.activeRotation,color:state.activeColor});
  state.selectedId=null; renderBlocks(); if(state.bgActive)applyBackground();
});

function selectBlock(id){
  if(state.selectedId===id){state.selectedId=null;document.getElementById('st-sel-info').style.display='none';}
  else{
    state.selectedId=id;
    const b=state.blocks.find(b=>b.id===id);
    document.getElementById('st-sel-info').style.display='';
    document.getElementById('st-sel').textContent=`${b.type}@(${b.row},${b.col})`;
  }
  renderBlocks();
}

function selectPiece(key){
  state.activePiece=key; state.activeColor=PIECE_COLORS[key];
  buildPieceButtons(); buildColorSwatches(); updateRotIndicator(); updateStatus();
}

function selectColor(c){
  state.activeColor=c;
  if(state.selectedId){const b=state.blocks.find(b=>b.id===state.selectedId);if(b){b.color=c;renderBlocks();if(state.bgActive)applyBackground();}}
  buildColorSwatches();
  document.getElementById('st-color').textContent='‚ñ†';
  document.getElementById('st-color').style.color=c;
}

function doRotate(){
  if(state.selectedId){const b=state.blocks.find(b=>b.id===state.selectedId);if(b){b.rotation=(b.rotation+1)%4;renderBlocks();if(state.bgActive)applyBackground();}}
  else{state.activeRotation=(state.activeRotation+1)%4;updateRotIndicator();updateStatus();}
}

function updateRotIndicator(){document.getElementById('rot-indicator').textContent=['‚Üë','‚Üí','‚Üì','‚Üê'][state.activeRotation];}

function doDelete(){
  if(!state.selectedId){toast('SELECT A BLOCK FIRST');return;}
  state.blocks=state.blocks.filter(b=>b.id!==state.selectedId);
  state.selectedId=null;document.getElementById('st-sel-info').style.display='none';
  renderBlocks();if(state.bgActive)applyBackground();
}

function doClear(){
  confirm2('CLEAR ALL?','This will remove all blocks from the canvas.',()=>{
    state.blocks=[];state.selectedId=null;
    document.getElementById('st-sel-info').style.display='none';
    renderBlocks();if(state.bgActive)applyBackground();
  });
}

function updateStatus(){
  document.getElementById('st-piece').textContent=state.activePiece;
  const sc=document.getElementById('st-color');sc.textContent='‚ñ†';sc.style.color=state.activeColor;
  document.getElementById('st-count').textContent=state.blocks.length;
  document.getElementById('st-rot').textContent=(state.activeRotation*90)+'¬∞';
  document.querySelectorAll('.piece-btn').forEach(btn=>btn.classList.toggle('active',btn.dataset.piece===state.activePiece));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BACKGROUND ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const bgCanvas=document.getElementById('bg-canvas');
const bgCtx=bgCanvas.getContext('2d');
let bgAnimFrame=null, bgBlocks=[], bgTime=0;

function applyBackground(){
  state.bgActive=true;
  bgBlocks=state.blocks.map(b=>({...b,cells:getAbsoluteCells(b)}));
  bgCanvas.classList.add('active');
  document.getElementById('bg-badge').classList.add('visible');
  if(!bgAnimFrame)animateBg();
  toast('BACKGROUND APPLIED!');
}

function resetBackground(){
  state.bgActive=false;
  if(bgAnimFrame){cancelAnimationFrame(bgAnimFrame);bgAnimFrame=null;}
  bgCanvas.classList.remove('active');
  document.getElementById('bg-badge').classList.remove('visible');
  bgCtx.clearRect(0,0,bgCanvas.width,bgCanvas.height);
  toast('BACKGROUND RESET');
}

function animateBg(){bgTime+=0.008;resizeBgCanvas();drawBg();bgAnimFrame=requestAnimationFrame(animateBg);}

function resizeBgCanvas(){
  if(bgCanvas.width!==window.innerWidth||bgCanvas.height!==window.innerHeight){
    bgCanvas.width=window.innerWidth;bgCanvas.height=window.innerHeight;
  }
}

function drawBg(){
  const W=bgCanvas.width,H=bgCanvas.height;
  bgCtx.clearRect(0,0,W,H);
  if(bgBlocks.length===0)return;
  const grd=bgCtx.createLinearGradient(0,0,W,H);
  grd.addColorStop(0,'#06060e');grd.addColorStop(1,'#0a0a1a');
  bgCtx.fillStyle=grd;bgCtx.fillRect(0,0,W,H);
  const patW=COLS*CELL,patH=ROWS*CELL;
  const tilesX=Math.ceil(W/patW)+2,tilesY=Math.ceil(H/patH)+2;
  const scrollX=(bgTime*20)%patW,scrollY=(bgTime*10)%patH;
  for(let ty=-1;ty<tilesY;ty++)for(let tx=-1;tx<tilesX;tx++){
    const ox=tx*patW-scrollX,oy=ty*patH-scrollY;
    bgBlocks.forEach(block=>block.cells.forEach(([r,c])=>{
      const bx=ox+c*CELL,by=oy+r*CELL,s=CELL-3;
      bgCtx.shadowColor=block.color;bgCtx.shadowBlur=8+Math.sin(bgTime*2+block.id)*4;
      bgCtx.fillStyle=block.color;bgCtx.globalAlpha=0.55+Math.sin(bgTime+block.id*0.7)*0.12;
      bgCtx.beginPath();bgCtx.roundRect(bx+1,by+1,s,s,2);bgCtx.fill();
      bgCtx.shadowBlur=0;bgCtx.fillStyle='rgba(255,255,255,0.15)';bgCtx.globalAlpha=0.6;
      bgCtx.fillRect(bx+2,by+2,s-2,4);
    }));
  }
  bgCtx.globalAlpha=1;bgCtx.shadowBlur=0;
  const vig=bgCtx.createRadialGradient(W/2,H/2,H*0.2,W/2,H/2,H*0.8);
  vig.addColorStop(0,'transparent');vig.addColorStop(1,'rgba(0,0,0,0.65)');
  bgCtx.fillStyle=vig;bgCtx.fillRect(0,0,W,H);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SAVE / LOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveDesign(){
  try{
    localStorage.setItem('tetrisscape_design',JSON.stringify({blocks:state.blocks,nextId:state.nextId,bgActive:state.bgActive,savedAt:new Date().toISOString()}));
    toast('DESIGN SAVED!');
  }catch(e){toast('SAVE FAILED');}
}

function loadDesign(){
  try{const raw=localStorage.getItem('tetrisscape_design');if(!raw){toast('NO SAVED DESIGN');return;}applyDesignData(JSON.parse(raw));toast('DESIGN LOADED!');}
  catch(e){toast('LOAD FAILED');}
}

function loadDefault(){
  confirm2('LOAD DEFAULT?','Replace canvas with the default Tetris¬∑Scape design?',()=>{applyDesignData({...DEFAULT_DESIGN});toast('DEFAULT LOADED!');});
}

function applyDesignData(data){
  state.blocks=data.blocks.map(b=>({...b}));
  state.nextId=data.nextId||(Math.max(0,...state.blocks.map(b=>b.id))+1);
  state.selectedId=null; renderBlocks();
  if(data.bgActive)setTimeout(()=>applyBackground(),100);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TETRIS GAME ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const gs = {
  board: [],
  active: null,
  next: null,
  score: 0, lines: 0, level: 1,
  gravity: 'down',
  running: false, paused: false, gameOver: false,
  dropInterval: 700,
  dropTimer: null,
  lockTimer: null,
};

function initBoard(){ gs.board=Array.from({length:GR},()=>Array(GC).fill(null)); }

function rndPiece(){
  const type=PIECE_TYPES[Math.floor(Math.random()*PIECE_TYPES.length)];
  return {type,rotation:0,r:0,c:Math.floor(GC/2)-1,color:PIECE_COLORS[type]};
}

function pieceCells(p){ return rotateCells(PIECES[p.type].cells,p.rotation).map(([r,c])=>[p.r+r,p.c+c]); }

function isValid(p,board=gs.board){
  return pieceCells(p).every(([r,c])=>r>=0&&r<GR&&c>=0&&c<GC&&!board[r][c]);
}

function gravDelta(){
  return {down:[1,0],up:[-1,0],left:[0,-1],right:[0,1]}[gs.gravity];
}

function doMove(dr,dc){
  if(!gs.active||gs.paused||gs.gameOver)return false;
  const moved={...gs.active,r:gs.active.r+dr,c:gs.active.c+dc};
  if(isValid(moved)){gs.active=moved;clearTimeout(gs.lockTimer);gs.lockTimer=null;renderGame();return true;}
  return false;
}

function doRotGame(dir=1){
  if(!gs.active||gs.paused||gs.gameOver)return;
  const nr=((gs.active.rotation+dir)%4+4)%4;
  const base={...gs.active,rotation:nr};
  for(const [kr,kc] of [[0,0],[0,1],[0,-1],[-1,0],[1,0],[0,2],[0,-2]]){
    const k={...base,r:base.r+kr,c:base.c+kc};
    if(isValid(k)){gs.active=k;renderGame();return;}
  }
}

function gravStep(){
  if(!gs.active||gs.paused||gs.gameOver)return;
  const [dr,dc]=gravDelta();
  const moved={...gs.active,r:gs.active.r+dr,c:gs.active.c+dc};
  if(isValid(moved)){gs.active=moved;clearTimeout(gs.lockTimer);gs.lockTimer=null;}
  else if(!gs.lockTimer){gs.lockTimer=setTimeout(lockPiece,500);}
  renderGame();
}

function hardDrop(){
  if(!gs.active||gs.paused||gs.gameOver)return;
  const [dr,dc]=gravDelta();
  let steps=0;
  while(isValid({...gs.active,r:gs.active.r+dr*(steps+1),c:gs.active.c+dc*(steps+1)}))steps++;
  gs.active={...gs.active,r:gs.active.r+dr*steps,c:gs.active.c+dc*steps};
  gs.score+=steps*2;
  clearTimeout(gs.lockTimer);
  lockPiece();
}

function ghostPiece(){
  if(!gs.active)return null;
  const [dr,dc]=gravDelta();
  let ghost={...gs.active};
  while(isValid({...ghost,r:ghost.r+dr,c:ghost.c+dc})){ghost={...ghost,r:ghost.r+dr,c:ghost.c+dc};}
  return ghost;
}

function lockPiece(){
  clearTimeout(gs.lockTimer); gs.lockTimer=null;
  pieceCells(gs.active).forEach(([r,c])=>{if(r>=0&&r<GR&&c>=0&&c<GC)gs.board[r][c]=gs.active.color;});
  clearLines();
  gs.active=gs.next;
  gs.next=rndPiece();
  spawnActive();
  if(!isValid(gs.active)){triggerGameOver();return;}
  updateGameUI(); renderGame();
}

function spawnActive(){
  const p=gs.active;
  switch(gs.gravity){
    case 'down':  p.r=0; p.c=Math.floor(GC/2)-1; break;
    case 'up':    p.r=GR-4; p.c=Math.floor(GC/2)-1; break;
    case 'left':  p.r=Math.floor(GR/2)-1; p.c=GC-4; break;
    case 'right': p.r=Math.floor(GR/2)-1; p.c=0; break;
  }
}

function clearLines(){
  let cleared=0;
  const flashCells=[];
  if(gs.gravity==='down'||gs.gravity==='up'){
    for(let r=GR-1;r>=0;r--){
      if(gs.board[r].every(c=>c!==null)){
        for(let c=0;c<GC;c++)flashCells.push([r,c]);
        gs.board.splice(r,1);
        if(gs.gravity==='down')gs.board.unshift(Array(GC).fill(null));
        else gs.board.push(Array(GC).fill(null));
        cleared++;r++;
      }
    }
  } else {
    for(let c=GC-1;c>=0;c--){
      if(gs.board.every(row=>row[c]!==null)){
        for(let r=0;r<GR;r++)flashCells.push([r,c]);
        gs.board.forEach(row=>row.splice(c,1));
        if(gs.gravity==='right')gs.board.forEach(row=>row.unshift(null));
        else gs.board.forEach(row=>row.push(null));
        cleared++;c++;
      }
    }
  }
  if(cleared>0){
    flashLines(flashCells);
    gs.score+=[0,100,300,500,800][Math.min(cleared,4)]*gs.level;
    gs.lines+=cleared;
    gs.level=Math.floor(gs.lines/10)+1;
    gs.dropInterval=Math.max(80,700-(gs.level-1)*55);
    restartDrop();
  }
}

function flashLines(cells){
  const all=document.getElementById('game-board').querySelectorAll('.game-cell');
  cells.forEach(([r,c])=>all[r*GC+c]?.classList.add('flash'));
  setTimeout(()=>all.forEach(el=>el.classList.remove('flash')),350);
}

function triggerGameOver(){
  gs.gameOver=true; gs.running=false;
  clearInterval(gs.dropTimer); clearTimeout(gs.lockTimer);
  document.getElementById('final-score-display').textContent='SCORE: '+gs.score;
  document.getElementById('game-over-screen').classList.add('show');
  renderGame();
}

function restartDrop(){
  clearInterval(gs.dropTimer);
  gs.dropTimer=setInterval(()=>{if(!gs.paused&&!gs.gameOver)gravStep();},gs.dropInterval);
}

// ‚îÄ‚îÄ GAME BOARD RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildGameBoard(){
  const board=document.getElementById('game-board');
  // Save overlay screens
  const gos=document.getElementById('game-over-screen');
  const ps=document.getElementById('pause-screen');
  board.innerHTML='';
  for(let r=0;r<GR;r++)for(let c=0;c<GC;c++){
    const el=document.createElement('div');
    el.className='game-cell'; el.dataset.r=r; el.dataset.c=c;
    board.appendChild(el);
  }
  board.appendChild(gos); board.appendChild(ps);
}

function renderGame(){
  const board=document.getElementById('game-board');
  const all=board.querySelectorAll('.game-cell');
  all.forEach(el=>{el.classList.remove('filled');el.style.removeProperty('--fill-color');});
  for(let r=0;r<GR;r++)for(let c=0;c<GC;c++){
    if(gs.board[r]?.[c]){
      const el=all[r*GC+c]; el.classList.add('filled');
      el.style.setProperty('--fill-color',gs.board[r][c]);
    }
  }
  board.querySelectorAll('.ghost-cell,.active-cell').forEach(el=>el.remove());
  const ghost=ghostPiece();
  if(ghost&&gs.active){
    pieceCells(ghost).forEach(([r,c])=>{
      if(r<0||r>=GR||c<0||c>=GC)return;
      const el=document.createElement('div'); el.className='ghost-cell';
      el.style.gridColumn=c+1; el.style.gridRow=r+1; board.appendChild(el);
    });
    pieceCells(gs.active).forEach(([r,c])=>{
      if(r<0||r>=GR||c<0||c>=GC)return;
      const el=document.createElement('div'); el.className='active-cell';
      el.style.setProperty('--piece-color',gs.active.color);
      el.style.gridColumn=c+1; el.style.gridRow=r+1; board.appendChild(el);
    });
  }
}

function drawNextPiece(){
  const cv=document.getElementById('next-piece-canvas');
  const ctx=cv.getContext('2d'); ctx.clearRect(0,0,cv.width,cv.height);
  if(!gs.next)return;
  const cells=rotateCells(PIECES[gs.next.type].cells,0); const s=16;
  const maxC=Math.max(...cells.map(([,c])=>c)),maxR=Math.max(...cells.map(([r])=>r));
  const ox=Math.floor((cv.width-(maxC+1)*s)/2),oy=Math.floor((cv.height-(maxR+1)*s)/2);
  cells.forEach(([r,c])=>{
    ctx.fillStyle=gs.next.color; ctx.shadowColor=gs.next.color; ctx.shadowBlur=6;
    ctx.fillRect(ox+c*s+1,oy+r*s+1,s-2,s-2);
    ctx.shadowBlur=0; ctx.fillStyle='rgba(255,255,255,0.25)';
    ctx.fillRect(ox+c*s+1,oy+r*s+1,s-2,4);
  });
}

function updateGameUI(){
  document.getElementById('g-score').textContent=gs.score;
  document.getElementById('g-lines').textContent=gs.lines;
  document.getElementById('g-level').textContent=gs.level;
  drawNextPiece(); updateDirArrows();
}

function updateDirArrows(){
  document.querySelectorAll('.dir-arrow').forEach(el=>el.classList.toggle('active',el.dataset.dir===gs.gravity));
}

function setGravity(dir){
  if(gs.gravity===dir)return;
  gs.gravity=dir; updateDirArrows();
  if(gs.active&&gs.running&&!gs.gameOver){
    spawnActive();
    if(!isValid(gs.active)){
      let found=false;
      for(let dr=-3;dr<=3&&!found;dr++)for(let dc=-3;dc<=3&&!found;dc++){
        const t={...gs.active,r:gs.active.r+dr,c:gs.active.c+dc};
        if(isValid(t)){gs.active=t;found=true;}
      }
    }
    clearTimeout(gs.lockTimer); gs.lockTimer=null; renderGame();
  }
  toast('GRAVITY: '+dir.toUpperCase());
}

function startGame(){
  initBoard();
  Object.assign(gs,{score:0,lines:0,level:1,dropInterval:700,gravity:'down',gameOver:false,paused:false,running:true});
  gs.next=rndPiece(); gs.active=rndPiece(); spawnActive();
  document.getElementById('game-over-screen').classList.remove('show');
  document.getElementById('pause-screen').classList.remove('show');
  document.getElementById('btn-pause-game').textContent='‚è∏ PAUSE   P';
  buildGameBoard(); updateGameUI(); renderGame(); restartDrop(); updateDirArrows();
}

function pauseGame(){
  if(!gs.running||gs.gameOver)return;
  gs.paused=!gs.paused;
  document.getElementById('pause-screen').classList.toggle('show',gs.paused);
  document.getElementById('btn-pause-game').textContent=gs.paused?'‚ñ∂ RESUME  P':'‚è∏ PAUSE   P';
}

function openGame(){
  document.getElementById('game-overlay').classList.add('open');
  buildGameBoard(); startGame();
}

function closeGame(){
  document.getElementById('game-overlay').classList.remove('open');
  clearInterval(gs.dropTimer); clearTimeout(gs.lockTimer); gs.running=false;
}

function keepGameDesign(){
  const scaledBlocks=[]; let sid=state.nextId;
  for(let r=0;r<GR;r++)for(let c=0;c<GC;c++){
    const color=gs.board[r]?.[c];
    if(color&&r<ROWS&&c*2<COLS){
      scaledBlocks.push({id:sid++,type:'O',row:r,col:c*2,rotation:0,color});
    }
  }
  closeGame();
  state.blocks=scaledBlocks; state.nextId=sid; state.selectedId=null;
  renderBlocks(); applyBackground(); toast('GAME DESIGN APPLIED!');
}

// ‚îÄ‚îÄ KEYBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', e=>{
  const gameOpen=document.getElementById('game-overlay').classList.contains('open');

  // Editor keys (only when game is closed)
  if(!gameOpen){
    if(e.key==='r'||e.key==='R')doRotate();
    if(e.key==='Delete'||e.key==='Backspace')doDelete();
    if(e.key==='Escape'){state.selectedId=null;renderBlocks();}
    return;
  }

  // Game keys
  const preventKeys=['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '];
  if(preventKeys.includes(e.key))e.preventDefault();
  if(!gs.running||gs.gameOver)return;

  switch(e.key){
    // Arrow Left/Right move the piece laterally (perpendicular to gravity)
    case 'ArrowLeft':
      if(gs.gravity==='down'||gs.gravity==='up')doMove(0,-1); else doMove(-1,0); break;
    case 'ArrowRight':
      if(gs.gravity==='down'||gs.gravity==='up')doMove(0,1);  else doMove(1,0);  break;

    // Arrow Up = rotate CW, Arrow Down = soft drop (one gravity step)
    case 'ArrowUp':    doRotGame(1); break;
    case 'ArrowDown':  gravStep();   break;

    // Rotate
    case 'z':case 'Z': doRotGame(1);  break;
    case 'x':case 'X': doRotGame(-1); break;

    // Hard drop
    case ' ': hardDrop(); break;

    // Pause
    case 'p':case 'P': pauseGame(); break;
  }
});

// ‚îÄ‚îÄ MODAL / TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let modalCallback=null;
function confirm2(title,body,cb){
  document.getElementById('modal-title').textContent=title;
  document.getElementById('modal-body').textContent=body;
  modalCallback=cb; document.getElementById('modal').classList.add('open');
}
document.getElementById('modal-ok').addEventListener('click',()=>{
  document.getElementById('modal').classList.remove('open');
  if(modalCallback)modalCallback(); modalCallback=null;
});
document.getElementById('modal-cancel').addEventListener('click',()=>{
  document.getElementById('modal').classList.remove('open'); modalCallback=null;
});

let toastTimer;
function toast(msg){
  const el=document.getElementById('toast'); el.textContent=msg;
  el.classList.add('show'); clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>el.classList.remove('show'),2200);
}

// ‚îÄ‚îÄ BUTTON BINDINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('btn-open-game').addEventListener('click', openGame);
document.getElementById('btn-rotate').addEventListener('click', doRotate);
document.getElementById('btn-delete').addEventListener('click', doDelete);
document.getElementById('btn-clear').addEventListener('click', doClear);
document.getElementById('btn-apply').addEventListener('click', applyBackground);
document.getElementById('btn-reset-bg').addEventListener('click', resetBackground);
document.getElementById('btn-save').addEventListener('click', saveDesign);
document.getElementById('btn-load').addEventListener('click', loadDesign);
document.getElementById('btn-load-default').addEventListener('click', loadDefault);
document.getElementById('btn-pause-game').addEventListener('click', pauseGame);
document.getElementById('btn-restart2').addEventListener('click', startGame);
document.getElementById('btn-close-game').addEventListener('click', closeGame);
document.getElementById('btn-restart').addEventListener('click', startGame);
document.getElementById('btn-keep-design').addEventListener('click', keepGameDesign);
document.getElementById('btn-close-game-over').addEventListener('click', closeGame);

document.querySelectorAll('.dir-arrow').forEach(el=>{
  el.addEventListener('click',()=>{if(gs.running&&!gs.gameOver)setGravity(el.dataset.dir);});
});

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
buildGrid(); buildPieceButtons(); buildColorSwatches(); updateRotIndicator();

const saved=localStorage.getItem('tetrisscape_design');
if(saved){try{applyDesignData(JSON.parse(saved));toast('WELCOME BACK!');}catch(e){applyDesignData({...DEFAULT_DESIGN});}}
else{applyDesignData({...DEFAULT_DESIGN});}

updateStatus();
window.addEventListener('resize',()=>{if(state.bgActive)drawBg();});
window.addEventListener('beforeunload',()=>{if(state.blocks.length>0)saveDesign();});
</script>
</body>
</html>
